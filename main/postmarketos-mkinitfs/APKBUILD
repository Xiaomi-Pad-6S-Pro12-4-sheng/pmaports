# Maintainer: Oliver Smith <ollieparanoid@postmarketos.org>
# Co-Maintainer: Clayton Craft <clayton@craftyguy.net>
pkgname=postmarketos-mkinitfs
pkgver=2.7.0
pkgrel=1
pkgdesc="Tool to generate initramfs images for postmarketOS"
url="https://gitlab.postmarketos.org/postmarketOS/postmarketos-mkinitfs"
depends="
	boot-deploy>=0.9
"
makedepends_build="go scdoc"
options="pmb:cross-native2"
replaces="mkinitfs"

triggers="$pkgname.trigger=\
/lib/firmware/*:\
/usr/lib/systemd/boot:\
/usr/lib/udev:\
/usr/libexec/pmos-tests-initramfs:\
/usr/share/deviceinfo:\
/usr/share/kernel/*:\
/usr/share/mkinitfs-triggers:\
/usr/share/mkinitfs/*\
"

# mkinitfs-vendor-$pkgver.tar.gz: vendored Go deps, is part of the release:
# https://gitlab.postmarketos.org/postmarketOS/postmarketos-mkinitfs/-/releases
source="
	https://gitlab.postmarketos.org/postmarketOS/postmarketos-mkinitfs/-/archive/$pkgver/postmarketos-mkinitfs-$pkgver.tar.gz
	https://gitlab.postmarketos.org/api/v4/projects/postmarketOS%2Fpostmarketos-mkinitfs/packages/generic/mkinitfs-vendor-$pkgver/$pkgver/mkinitfs-vendor-$pkgver.tar.gz
	"

install="$pkgname.post-upgrade"
arch="all"
license="GPL-2.0-or-later"
provider_priority=999  # higher priority than Alpine's mkinitfs
provides="initramfs-generator"
subpackages="$pkgname-doc"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"
export GOPATH="$srcdir"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"

prepare() {
	default_prepare
	ln -s "$srcdir"/vendor "$builddir"/vendor
}

build() {
	unset LDFLAGS  # passed to Go as linker flags, which are invalid

	# * Set DISABLE_GOGC=1 for e.g. aarch64 -> x86_64 for:
	#   https://gitlab.com/qemu-project/qemu/-/issues/2560
	# * Set CGO_ENABLED=1 to fix "-buildmode=pie requires external (cgo)
	#   linking, but cgo is not enabled" when cross compiling with
	#   cross-native2 from e.g. x86_64 to (armv7,riscv64,armhf). See also:
	#   https://gitlab.alpinelinux.org/alpine/aports/-/issues/15809
	case "$CARCH" in
	x86_64)
		make VERSION="$pkgver" DISABLE_GOGC=1 CGO_ENABLED=1;;
	*)
		make VERSION="$pkgver" CGO_ENABLED=1;;
	esac
}

package() {
	make PREFIX=/usr DESTDIR="$pkgdir" install
}

check() {
	go test ./...
}

sha512sums="
ea32f2bd8f10703bcdf7beb5f9854d466018a0a3e5697889a683e0b26026ba8189224a9e0c6a9a04d05e73ff814406c043ca3a56d871e3bb46aa8315ba58267c  postmarketos-mkinitfs-2.7.0.tar.gz
7e773fe412defb5631ff1a8e2f5e000acef2abe4a9086f9125e36d6e96e16a106f2f1cf898af1a6f1eb01fda7b3200cb36dd26e66f73b7f6c8e91076829b93c9  mkinitfs-vendor-2.7.0.tar.gz
"

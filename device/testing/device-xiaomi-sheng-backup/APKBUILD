# Reference: <https://postmarketos.org/devicepkg>
# Maintainer: alghiffaryfa19 <alghiffaryfa19@gmail.com>
pkgname=device-xiaomi-sheng
pkgdesc="Xiaomi Mi Pad 6s Pro"
pkgver=5
pkgrel=2
url="https://postmarketos.org"
license="MIT"
arch="aarch64"
options="!check !archcheck"
depends="
	alsa-ucm-conf
	bootmac
	hexagonrpcd>=0.3.2-r3
	make-dynpart-mappings
	mesa-vulkan-freedreno
	mkbootimg
	postmarketos-base
	qbootctl
	swclock-offset
"
makedepends="devicepkg-dev"
source="
	81-libssc-xiaomi-sheng.rules
	alsa-ucm-conf/sheng.conf
	alsa-ucm-conf/HiFi.conf
	deviceinfo
	30-gpu-firmware.files
"

subpackages="
	$pkgname-kernel:kernel
	$pkgname-nonfree-firmware:nonfree_firmware
	$pkgname-openrc
"

build() {
	devicepkg_build $startdir $pkgname
}

package() {
	devicepkg_package $startdir $pkgname

	install -Dm644 "$srcdir"/deviceinfo \
		"$pkgdir"/usr/share/deviceinfo/deviceinfo

	install -Dm64 "$srcdir"/30-gpu-firmware.files -t \
		"$pkgdir"/usr/share/mkinitfs/files

	# device-specific alsa ucm conf
	install -Dm644 "$srcdir/sheng.conf" \
		"$pkgdir/usr/share/alsa/ucm2/Xiaomi/sheng/sheng.conf"

	install -Dm644 "$srcdir/HiFi.conf" \
		"$pkgdir/usr/share/alsa/ucm2/Xiaomi/sheng/HiFi.conf"

	mkdir -p "$pkgdir/usr/share/alsa/ucm2/conf.d/sm8550"
	ln -s ../../Xiaomi/sheng/sheng.conf \
		"$pkgdir/usr/share/alsa/ucm2/conf.d/sm8550/Xiaomi Mi Pad 6s Pro.conf"

	install -Dm644 "$srcdir"/81-libssc-xiaomi-sheng.rules \
		"$pkgdir"/usr/lib/udev/rules.d/81-libssc-xiaomi-sheng.rules
}

kernel() {
	pkgdesc="Kernel"
	depends="linux-postmarketos-qcom-sm8550"
	devicepkg_subpackage_kernel $startdir $pkgname $subpkgname
}

nonfree_firmware() {
	pkgdesc="Firmware"
	depends="firmware-xiaomi-sheng"
	mkdir "$subpkgdir"
}

openrc() {
	install_if="$pkgname=$pkgver-r$pkgrel openrc"
	install="$subpkgname.post-install $subpkgname.post-upgrade"

	mkdir -p "$subpkgdir"
}

sha512sums="
48040cf36ae7fe9ec271b60e35141b8c7af57905e4f0961e7b23e4a8517d0ceb74e824fc2b69260bf01135dfc98d30b648a36f07ab496d36802ee78a2fb4d541  81-libssc-xiaomi-sheng.rules
f8d44dc9c360f39926030e1b15db973458418f4376739afdf8ef1d9bf0e2b21bef66ebe73197aa30dd9c31e8c00ca5784ce8caae7fa94df48546cf1961fbaa22  sheng.conf
33309cf731e482d584a8f0a6565e4decdb6f1c61a1ce4191e4e5eb6d78e897987d0ef90375d806fa1c859b083bff244f507414cb0e5344350158f9075299e906  HiFi.conf
cc19101a967b6b3b689b6730c35cc7f1980630e923a159f480a104835e148de80b4ff68b7f4aeab766dd16517b174e0f1cd23b95fad373e6f62a7d66e5310308  deviceinfo
"
